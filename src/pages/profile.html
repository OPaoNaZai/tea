<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        .profile-container { padding: 0; position: relative; }
        .white-box { background-color: white; border-radius: 8px; padding: 20px; margin: 0 20px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 20px !important; }
        .user-profile-box { position: relative; margin-top: -5% !important; z-index: 10; }
        .user-info { display: flex; align-items: center; }
        .avatar { width: 80px; height: 80px; border-radius: 50%; margin-right: 20px; background-image: url('../assets/images/avatar.png'); background-size: cover; background-position: center; }
        .user-info-box h2 { margin: 0 0 8px 0; }
        .user-info-box p { margin: 0 0 4px 0; color: #666; }
        .function-list { list-style: none; padding: 0; margin: 0; }
        .function-list-horizontal { display: flex; flex-wrap: wrap; }
        .function-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; text-align: center; flex: 1; min-width: 20%; }
        .function-item-non-clickable { padding: 15px; border-bottom: 1px solid #eee; cursor: default; text-align: center; flex: 1; min-width: 20%; }
        .function-list .function-item { text-align: left; position: relative; }
        .function-list .function-item::after { content: ">"; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .function-item:last-child { border-bottom: none; }
        .function-item:hover { background-color: #f8f9fa; }
        body { background-color: #e3f2fd; margin: 0; padding: 0; }
        .img-container { width: 100vw; max-width: 100%; padding: 0; margin: 0; background-color: #ff7e5f; height: 260px; }
        .img-container img { display: none; }
        .auth-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(2px); }
        .auth-modal.show { display: flex !important; }
        .auth-header { background-color: #007bff; color: white; padding: 15px; border-top-left-radius: 8px; border-top-right-radius: 8px; position: relative; text-align: center; }
        .auth-content { background-color: white; border-radius: 8px; width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); overflow: hidden; }
        .close-btn { position: absolute; top: 12px; right: 15px; width: 24px; height: 24px; border: none; background-color: transparent; color: white; font-size: 20px; line-height: 1; cursor: pointer; padding: 0; margin: 0; transition: color 0.3s; }
        .close-btn:hover { color: #f0f0f0; }
        .auth-body { padding: 20px; }
        .auth-body h2 { margin: 0 0 20px 0; text-align: center; font-size: 20px; }
        .auth-body input { width: 100%; margin-bottom: 15px; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .auth-body button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
        .auth-body button:hover { background-color: #0056b3; }
        .switch-btn { display: block; width: 100%; text-align: center; background-color: transparent !important; color: #007bff !important; padding: 0 !important; margin-top: 10px; border: none; cursor: pointer; }
        .switch-btn:hover { text-decoration: underline; }
        #profileContent { display: block; }
        .login-register-btn { background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.3s; }
        .login-register-btn:hover { background-color: #0056b3; transform: translateY(-1px); }
        .edit-profile-container { padding: 20px; background-color: #e3f2fd; min-height: 100vh; }
        .edit-profile-box { background-color: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .edit-item { margin-bottom: 20px; }
        .edit-item label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .edit-item input { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .edit-item input[readonly] { background-color: #f8f9fa; cursor: not-allowed; }
        .save-btn { background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 12px 20px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px; margin-bottom: 10px; }
        .save-btn:hover { background-color: #0056b3; }
        .back-btn { background-color: #fff; color: #007bff; border: 1px solid #007bff; border-radius: 4px; padding: 12px 20px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px; }
        .back-btn:hover { background-color: #f8f9fa; }
        .logout-btn { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 12px 20px; cursor: pointer; font-size: 16px; width: 100%; }
        .logout-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content" id="loginForm">
            <div class="auth-header">
                <button class="close-btn" onclick="window.closeAuthModal()">&times;</button>
                <h2>ç”¨æˆ·ç™»å½•</h2>
            </div>
            <div class="auth-body">
                <input type="text" id="loginAccount" placeholder="é‚®ç®±/æ‰‹æœºå·" required>
                <input type="password" id="loginPwd" placeholder="å¯†ç " required>
                <button onclick="window.handleLogin()">ç™»å½•</button>
                <button class="switch-btn" onclick="window.switchToRegister()">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</button>
            </div>
        </div>
        <div class="auth-content" id="registerForm" style="display: none;">
            <div class="auth-header">
                <button class="close-btn" onclick="window.closeAuthModal()">&times;</button>
                <h2>ç”¨æˆ·æ³¨å†Œ</h2>
            </div>
            <div class="auth-body">
                <input type="text" id="regNickname" placeholder="ç”¨æˆ·å" required>
                <input type="text" id="regPhone" placeholder="æ‰‹æœºå·" required>
                <input type="email" id="regEmail" placeholder="é‚®ç®±ï¼ˆå¦‚ xxx@qq.comï¼‰" required>
                <input type="password" id="regPwd" placeholder="å¯†ç ï¼ˆä¸å°‘äº6ä½ï¼‰" required>
                <button onclick="window.handleRegister()">æ³¨å†Œå¹¶å‘é€éªŒè¯é‚®ä»¶</button>
                <button class="switch-btn" onclick="window.switchToLogin()">å·²æœ‰è´¦å·ï¼Ÿè¿”å›ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸­å¿ƒå†…å®¹ -->
    <div class="profile-container" id="profileContent">
        <div class="img-container">
            <img src="../assets/images/background.png" alt="èƒŒæ™¯å›¾">
        </div>
        <div class="white-box user-profile-box">
            <div class="user-info">
                <div class="avatar"></div>
                <div class="user-info-box">
                    <button class="login-register-btn" onclick="window.showAuthModal()">ç™»å½•/æ³¨å†Œ</button>
                    <p id="displayPhone">ç”µè¯ï¼šæœªè®¾ç½®</p>
                    <p id="displayEmail">é‚®ç®±ï¼šæœªè®¾ç½®</p>
                </div>
            </div>
        </div>
        <div class="white-box">
            <div class="function-list-horizontal">
                <div class="function-item-non-clickable" id="userPoints">0<br>ç§¯åˆ†</div>
                <div class="function-item-non-clickable" id="userGiftCards">0<br>ç¤¼å“å¡</div>
                <div class="function-item-non-clickable" id="userCoupons">0<br>ä¼˜æƒ åˆ¸</div>
            </div>
        </div>
        <div class="white-box">
            <ul class="function-list">
                <li class="function-item">
                    <a href="points.html" style="text-decoration: none; color: inherit; display: block; width: 100%; height: 100%;">ğŸ ç§¯åˆ†å•†åŸ</a>
                </li>
                <li class="function-item">
                    <a href="address.html" style="text-decoration: none; color: inherit; display: block; width: 100%; height: 100%;">ğŸ  æ”¶è´§åœ°å€</a>
                </li>
                <li class="function-item" id="myProfileItem">
                    <a href="javascript:void(0);" onclick="window.goToEditProfile()" style="text-decoration: none; color: inherit; display: block; width: 100%; height: 100%;">âš™ï¸ è´¦å·è®¾ç½®</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- ç¼–è¾‘ä¸ªäººèµ„æ–™é¡µé¢ -->
    <div class="edit-profile-container" id="editProfileContent" style="display: none;">
        <div class="edit-profile-box">
            <button class="back-btn" onclick="window.backToProfile()">è¿”å›æˆ‘çš„é¡µé¢</button>
            <div class="edit-item">
                <label for="editNickname">ç”¨æˆ·å</label>
                <input type="text" id="editNickname" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
            </div>
            <div class="edit-item">
                <label for="editPhone">æ‰‹æœºå·</label>
                <input type="text" id="editPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" readonly>
            </div>
            <div class="edit-item">
                <label for="editEmail">é‚®ç®±</label>
                <input type="email" id="editEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" readonly>
            </div>
            <button class="save-btn" onclick="window.saveProfile()">ä¿å­˜ä¿®æ”¹</button>
            <button class="logout-btn" onclick="window.handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const SUPABASE_URL = "https://gfvzqdydcjynxseiswwh.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmdnpxZHlkY2p5bnhzZWlzd3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDI0MDksImV4cCI6MjA3ODMxODQwOX0.n0gaMxtldCFEw0PkH_NKyN6J_e1vKJ5s8GwsKOGq0Q0";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // å…¨å±€å˜é‡
        let authModal, profileContent, editProfileContent, loginForm, registerForm, myProfileItem;
        let currentUserId = null;
        const STORAGE_KEY = 'persistent_auth_session';
        const STORAGE_EVENT_KEY = 'cross_tab_auth_event';
        const SESSION_EXPIRE_HOURS = 24;
        const FIRST_VISIT_KEY = 'first_visit'; // æ ‡è®°æ˜¯å¦é¦–æ¬¡è¿›å…¥ç½‘ç«™

        // åˆå§‹åŒ–DOMå…ƒç´ 
        function initDOM() {
            authModal = document.getElementById('authModal');
            profileContent = document.getElementById('profileContent');
            editProfileContent = document.getElementById('editProfileContent');
            loginForm = document.getElementById('loginForm');
            registerForm = document.getElementById('registerForm');
            myProfileItem = document.getElementById('myProfileItem');
            authModal.classList.remove('show');
            editProfileContent.style.display = 'none';
        }

        // ä¿å­˜sessionåˆ°æœ¬åœ°å­˜å‚¨
        function saveSessionToLocalStorage(userId) {
            const expiresAt = new Date().getTime() + SESSION_EXPIRE_HOURS * 60 * 60 * 1000;
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ userId, expiresAt }));
            localStorage.setItem(FIRST_VISIT_KEY, 'false'); // æ ‡è®°ä¸ºéé¦–æ¬¡è®¿é—®
        }

        // ä»æœ¬åœ°å­˜å‚¨æ¸…é™¤session
        function clearSessionFromLocalStorage() {
            localStorage.removeItem(STORAGE_KEY);
            // ä¿ç•™FIRST_VISIT_KEYï¼Œé¿å…å†æ¬¡è¿›å…¥æ—¶é‡å¤å¼¹çª—
        }

        // å¤„ç†è·¨é¡µé¢å­˜å‚¨äº‹ä»¶
        function handleCrossTabStorageEvent(event) {
            if (event.key === STORAGE_EVENT_KEY) {
                try {
                    const eventData = JSON.parse(event.newValue);
                    if (eventData.event === 'SIGNED_IN') {
                        currentUserId = eventData.userId;
                        renderLoggedInState(eventData.userId);
                    } else if (eventData.event === 'SIGNED_OUT') {
                        currentUserId = null;
                        renderLoggedOutState();
                    }
                } catch (e) {
                    console.error('è§£æè·¨é¡µé¢å­˜å‚¨äº‹ä»¶å¤±è´¥:', e);
                }
            }
        }

        // å‘é€è·¨é¡µé¢è®¤è¯äº‹ä»¶
        function sendCrossTabAuthEvent(event, userId = null) {
            const eventData = { event, userId };
            localStorage.setItem(STORAGE_EVENT_KEY, JSON.stringify(eventData));
        }

        // åˆå§‹åŒ–å‡½æ•°
        (async function init() {
            initDOM();
            window.addEventListener('storage', handleCrossTabStorageEvent);

            // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è¿›å…¥ç½‘ç«™
            const isFirstVisit = localStorage.getItem(FIRST_VISIT_KEY) !== 'false';
            
            // ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç™»å½•çŠ¶æ€
            const savedSession = localStorage.getItem(STORAGE_KEY);
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData.expiresAt > new Date().getTime()) {
                        currentUserId = sessionData.userId;
                        await renderLoggedInState(sessionData.userId);
                        return;
                    } else {
                        localStorage.removeItem(STORAGE_KEY); // sessionè¿‡æœŸ
                    }
                } catch (e) {
                    localStorage.removeItem(STORAGE_KEY); // è§£æå¤±è´¥
                }
            }

            // éªŒè¯Supabaseä¼šè¯
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session && session.user) {
                    currentUserId = session.user.id;
                    saveSessionToLocalStorage(session.user.id);
                    await renderLoggedInState(session.user.id);
                } else {
                    currentUserId = null;
                    renderLoggedOutState();
                    // ä»…é¦–æ¬¡è¿›å…¥æ—¶æ˜¾ç¤ºç™»å½•å¼¹çª—
                    if (isFirstVisit) {
                        setTimeout(() => {
                            window.showAuthModal();
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('éªŒè¯Supabaseä¼šè¯å¤±è´¥:', error);
                currentUserId = null;
                renderLoggedOutState();
                if (isFirstVisit) {
                    setTimeout(() => {
                        window.showAuthModal();
                    }, 500);
                }
            }

            // ç›‘å¬Supabase authçŠ¶æ€å˜åŒ–
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    currentUserId = session.user.id;
                    saveSessionToLocalStorage(session.user.id);
                    sendCrossTabAuthEvent('SIGNED_IN', session.user.id);
                } else if (event === 'SIGNED_OUT') {
                    currentUserId = null;
                    clearSessionFromLocalStorage();
                    sendCrossTabAuthEvent('SIGNED_OUT');
                }
            });
        })();

        // æ¸²æŸ“ç™»å½•çŠ¶æ€
        function renderLoggedInState(userId) {
            supabase
                .from('users')
                .select('nick_name, phone, email, points, gift_cards, coupons')
                .eq('user_id', userId)
                .single()
                .then(({ data, error }) => {
                    const userData = {
                        nick_name: data?.nick_name || 'é»˜è®¤ç”¨æˆ·',
                        phone: data?.phone || 'æœªè®¾ç½®',
                        email: data?.email || 'æœªè®¾ç½®',
                        points: data?.points || 0,
                        gift_cards: data?.gift_cards || 0,
                        coupons: data?.coupons || 0
                    };

                    const userInfoBox = document.querySelector('.user-info-box');
                    const loginBtn = userInfoBox.querySelector('.login-register-btn');
                    
                    if (loginBtn) {
                        const nickNameElement = document.createElement('h2');
                        nickNameElement.id = 'displayNickname';
                        nickNameElement.textContent = userData.nick_name;
                        userInfoBox.insertBefore(nickNameElement, loginBtn);
                        userInfoBox.removeChild(loginBtn);
                    } else {
                        document.getElementById('displayNickname').textContent = userData.nick_name;
                    }

                    document.getElementById('displayPhone').textContent = `ç”µè¯ï¼š${userData.phone}`;
                    document.getElementById('displayEmail').textContent = `é‚®ç®±ï¼š${userData.email}`;
                    document.getElementById('userPoints').innerHTML = `${Number(userData.points)}<br>ç§¯åˆ†`;
                    document.getElementById('userGiftCards').innerHTML = `${Number(userData.gift_cards)}<br>ç¤¼å“å¡`;
                    document.getElementById('userCoupons').innerHTML = `${Number(userData.coupons)}<br>ä¼˜æƒ åˆ¸`;

                    myProfileItem.style.display = 'block';
                })
                .catch((error) => {
                    console.error('æ¸²æŸ“ç™»å½•çŠ¶æ€å¤±è´¥ï¼š', error.message);
                    document.getElementById('displayNickname').textContent = 'é»˜è®¤ç”¨æˆ·';
                    document.getElementById('displayPhone').textContent = 'ç”µè¯ï¼šæœªè®¾ç½®';
                    document.getElementById('displayEmail').textContent = 'é‚®ç®±ï¼šæœªè®¾ç½®';
                    myProfileItem.style.display = 'block';
                });
        }

        // æ¸²æŸ“æœªç™»å½•çŠ¶æ€
        function renderLoggedOutState() {
            const userInfoBox = document.querySelector('.user-info-box');
            const loginBtn = userInfoBox.querySelector('.login-register-btn');
            const nickNameElement = document.getElementById('displayNickname');
            
            if (nickNameElement) {
                userInfoBox.removeChild(nickNameElement);
            }
            
            if (!loginBtn) {
                const newLoginBtn = document.createElement('button');
                newLoginBtn.className = 'login-register-btn';
                newLoginBtn.onclick = window.showAuthModal;
                newLoginBtn.textContent = 'ç™»å½•/æ³¨å†Œ';
                userInfoBox.insertBefore(newLoginBtn, document.getElementById('displayPhone'));
            }
            
            document.getElementById('displayPhone').textContent = 'ç”µè¯ï¼šæœªè®¾ç½®';
            document.getElementById('displayEmail').textContent = 'é‚®ç®±ï¼šæœªè®¾ç½®';
            myProfileItem.style.display = 'block';
            document.getElementById('userPoints').innerHTML = '0<br>ç§¯åˆ†';
            document.getElementById('userGiftCards').innerHTML = '0<br>ç¤¼å“å¡';
            document.getElementById('userCoupons').innerHTML = '0<br>ä¼˜æƒ åˆ¸';
        }

        // æ˜¾ç¤ºç™»å½•/æ³¨å†Œå¼¹çª—
        window.showAuthModal = () => {
            authModal.classList.add('show');
            switchToLogin(); // é»˜è®¤æ˜¾ç¤ºç™»å½•è¡¨å•
        };

        // å…³é—­å¼¹çª—
        window.closeAuthModal = () => {
            authModal.classList.remove('show');
        };

        // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
        window.switchToLogin = () => {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        };

        // åˆ‡æ¢åˆ°æ³¨å†Œè¡¨å•
        window.switchToRegister = () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        };

        // å¤„ç†æ³¨å†Œ
        window.handleRegister = async () => {
            const nickName = document.getElementById('regNickname').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pwd = document.getElementById('regPwd').value.trim();

            if (!nickName || !phone || !email || !pwd) {
                alert('è¯·å¡«å†™å®Œæ•´æ³¨å†Œä¿¡æ¯');
                return;
            }
            if (phone.length !== 11) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·');
                return;
            }
            const emailReg = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailReg.test(email)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            if (pwd.length < 6) {
                alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½');
                return;
            }

            try {
                const { data: { user }, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: pwd,
                    options: { data: { phone, nick_name: nickName } }
                });
                if (authError) throw authError;
                if (!user) throw new Error('æ³¨å†Œå¤±è´¥');

                const { error: dbError } = await supabase
                    .from('users')
                    .insert([{
                        user_id: user.id,
                        nick_name: nickName,
                        phone,
                        email,
                        points: 0,
                        gift_cards: 0,
                        coupons: 0
                    }]);
                if (dbError) throw new Error('æ³¨å†ŒæˆåŠŸï¼Œä½†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨å¤±è´¥');

                alert('æ³¨å†ŒæˆåŠŸï¼è¯·å‰å¾€é‚®ç®±éªŒè¯åç™»å½•');
                window.closeAuthModal();
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥ï¼š', error.message);
                alert(error.message.includes('Email already registered') ? 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ' : 'æ³¨å†Œå¤±è´¥ï¼š' + error.message);
            }
        };

        // å¤„ç†ç™»å½•
        window.handleLogin = async () => {
            const loginAccount = document.getElementById('loginAccount').value.trim();
            const pwd = document.getElementById('loginPwd').value.trim();

            if (!loginAccount || !pwd) {
                alert('è¯·å¡«å†™è´¦å·ï¼ˆé‚®ç®±/æ‰‹æœºå·ï¼‰å’Œå¯†ç ');
                return;
            }

            try {
                let authUser = null;
                const emailReg = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

                if (emailReg.test(loginAccount)) {
                    const { data: { user }, error: emailAuthError } = await supabase.auth.signInWithPassword({
                        email: loginAccount,
                        password: pwd
                    });
                    if (emailAuthError) throw emailAuthError;
                    authUser = user;
                } else {
                    const { data: userData, error: queryError } = await supabase
                        .from('users')
                        .select('email')
                        .eq('phone', loginAccount)
                        .single();
                    if (queryError) throw new Error('è¯¥æ‰‹æœºå·æœªæ³¨å†Œ');
                    if (!userData?.email) throw new Error('æœªæŸ¥è¯¢åˆ°å…³è”é‚®ç®±');

                    const { data: { user }, error: phoneAuthError } = await supabase.auth.signInWithPassword({
                        email: userData.email,
                        password: pwd
                    });
                    if (phoneAuthError) throw phoneAuthError;
                    authUser = user;
                }

                if (!authUser.email_confirmed_at) {
                    await supabase.auth.signOut();
                    alert('è¯·å…ˆéªŒè¯é‚®ç®±åå†ç™»å½•');
                    return;
                }

                currentUserId = authUser.id;
                await renderLoggedInState(authUser.id);
                alert('ç™»å½•æˆåŠŸï¼');
                window.closeAuthModal();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥ï¼š', error.message);
                alert(error.message.includes('Invalid login credentials') ? 'ç™»å½•å¤±è´¥ï¼šè´¦å·æˆ–å¯†ç é”™è¯¯' : 'ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        };

        // å¤„ç†é€€å‡ºç™»å½•
        window.handleLogout = async () => {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;

            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUserId = null;
                clearSessionFromLocalStorage();
                sendCrossTabAuthEvent('SIGNED_OUT');
                editProfileContent.style.display = 'none';
                profileContent.style.display = 'block';
                renderLoggedOutState();
                alert('å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥ï¼š', error.message);
                alert('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };

        // å‰å¾€ç¼–è¾‘èµ„æ–™é¡µé¢
        window.goToEditProfile = async () => {
            if (!currentUserId) {
                window.showAuthModal();
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('nick_name, phone, email')
                    .eq('user_id', currentUserId)
                    .single();
                if (error || !data) throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');

                document.getElementById('editNickname').value = data.nick_name || '';
                document.getElementById('editPhone').value = data.phone || '';
                document.getElementById('editEmail').value = data.email || '';

                profileContent.style.display = 'none';
                editProfileContent.style.display = 'block';
            } catch (error) {
                console.error('å‰å¾€ç¼–è¾‘é¡µé¢å¤±è´¥ï¼š', error.message);
                alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        };

        // è¿”å›æˆ‘çš„é¡µé¢
        window.backToProfile = () => {
            editProfileContent.style.display = 'none';
            profileContent.style.display = 'block';
            if (currentUserId) {
                renderLoggedInState(currentUserId);
            }
        };

        // ä¿å­˜ä¸ªäººèµ„æ–™
        window.saveProfile = async () => {
            if (!currentUserId) {
                window.showAuthModal();
                return;
            }

            const newNickname = document.getElementById('editNickname').value.trim();
            if (!newNickname) {
                alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
                return;
            }

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ nick_name: newNickname })
                    .eq('user_id', currentUserId);
                if (error) throw error;

                await supabase.auth.updateUser({
                    data: { nick_name: newNickname }
                });

                alert('ä¿å­˜æˆåŠŸï¼');
                window.backToProfile();
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥ï¼š', error.message);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼š' + error.message);
            }
        };
    </script>
</body>
</html>