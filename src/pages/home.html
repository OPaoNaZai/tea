<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥¶èŒ¶å°é“º - ç‚¹å•é¡µé¢</title>
    <!-- ç¡®ä¿å›¾æ ‡åº“æ­£ç¡®å¼•å…¥ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½®ä¸åŸºç¡€è®¾ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Heiti SC', sans-serif;
        }

        body {
            background-color: #f9f5f0;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨è´­ç‰©è½¦æ é¢„ç•™ç©ºé—´ */
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 1rem;
        }

        .logo { display: flex; align-items: center; gap: 0.8rem; }
        .logo h1 { font-size: 1.5rem; color: #ff7e5f; letter-spacing: 1px; }
        .logo i { font-size: 1.8rem; color: #ff7e5f; }

        .search-container { flex: 1; max-width: 500px; position: relative; }
        .search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 2.8rem; border: 1px solid #ffd1c0; border-radius: 30px; font-size: 1rem; color: #333; background-color: #fef6f2; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: #ff7e5f; box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #ff7e5f; font-size: 1.1rem; }

        .mode-switch { display: flex; border: 1px solid #ffd1c0; border-radius: 30px; overflow: hidden; }
        .mode-btn { padding: 0.6rem 1.5rem; border: none; background-color: transparent; color: #ff7e5f; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .mode-btn i { font-size: 1.1rem; }
        .mode-btn.active { background-color: #ff7e5f; color: white; }
        .mode-btn:hover:not(.active) { background-color: #fef6f2; }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content { display: flex; height: calc(100vh - 76px - 80px); }

        /* å·¦ä¾§åˆ†ç±»èœå• */
        .category-menu { width: 260px; background-color: white; box-shadow: 2px 0 10px rgba(0,0,0,0.05); padding: 1.5rem 0; position: fixed; height: calc(100vh - 76px - 80px); overflow-y: auto; z-index: 90; }
        .category-menu h2 { color: #ff7e5f; font-size: 1.2rem; padding: 0 1.8rem 0.8rem; margin-bottom: 1rem; border-bottom: 2px solid #f9f5f0; display: flex; align-items: center; gap: 0.5rem; }
        .category-list { list-style: none; }
        .category-item { padding: 1.1rem 1.8rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 1rem; font-size: 1.05rem; }
        .category-item i { color: #ff7e5f; font-size: 1.2rem; width: 24px; text-align: center; }
        .category-item:hover { background-color: #fef6f2; }
        .category-item.active { background-color: #ff7e5f; color: white; position: relative; }
        .category-item.active::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background-color: #d65a31; }
        .category-item.active i { color: white; }

        /* å³ä¾§äº§å“åˆ—è¡¨ */
        .product-container { margin-left: 260px; flex: 1; padding: 2rem; overflow-y: auto; }
        .product-header { margin-bottom: 1.5rem; }
        .product-header h2 { font-size: 1.5rem; color: #333; margin-bottom: 0.5rem; }
        .product-header p { color: #666; font-size: 0.95rem; }
        .search-result-tip { color: #666; font-size: 1rem; margin-bottom: 1.5rem; display: none; }

        /* äº§å“ç½‘æ ¼å¸ƒå±€ */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.8rem; }

        /* äº§å“å¡ç‰‡ä¼˜åŒ– */
        .product-card { background-color: white; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 3px 15px rgba(0,0,0,0.07); transition: all 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
        .product-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #ff7e5f, #feb47b); opacity: 0; transition: opacity 0.3s ease; }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
        .product-card:hover::before { opacity: 1; }
        .product-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1.2rem; transition: transform 0.5s ease; }
        .product-card:hover .product-img { transform: scale(1.05); }
        .product-title { font-size: 1.15rem; color: #333; margin-bottom: 0.6rem; font-weight: 600; }
        .product-desc { color: #666; font-size: 0.9rem; margin-bottom: 1.2rem; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0 0.5rem; }
        .product-price { color: #ff7e5f; font-size: 1.3rem; font-weight: 700; margin-bottom: 1.2rem; }

        .add-to-cart { width: 100%; padding: 0.9rem 0; border: none; border-radius: 25px; background-color: #fef6f2; color: #ff7e5f; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; pointer-events: auto; }
        .add-to-cart:hover { background-color: #ff7e5f; color: white; }
        
        .product-card > *:not(.add-to-cart) { pointer-events: none; }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; color: #999; text-align: center; display: none; }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; color: #ffd1c0; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #ffc1a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #ff7e5f; }

        /* ----------------- è´­ç‰©è½¦æ ·å¼ ----------------- */
        /* åº•éƒ¨è´­ç‰©è½¦æ‘˜è¦æ  - å›¾1æ•ˆæœ */
        .cart-summary-bar { 
            position: fixed; 
            bottom: 80px; 
            left: 0; 
            width: 100%; 
            background-color: white; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.8rem 2rem; 
            z-index: 95;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(0);
            opacity: 1;
        }
        .cart-summary-bar.hidden {
            transform: translateY(100%);
            opacity: 0;
        }
        .cart-summary-info { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            cursor: pointer; 
            flex: 1;
        }
        .cart-summary-icon-container { position: relative; }
        .cart-summary-icon { font-size: 1.5rem; color: #ff7e5f; }
        .cart-summary-count { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background-color: #ff7e5f; 
            color: white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.8rem; 
            font-weight: bold; 
        }
        .cart-summary-text { 
            font-size: 1rem; 
            font-weight: 600; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .cart-summary-text span {
            color: #ff7e5f;
            font-weight: bold;
        }
        .cart-summary-total { font-size: 1.1rem; font-weight: bold; color: #ff7e5f; }
        .cart-summary-checkout { 
            padding: 0.6rem 1.5rem; 
            border: none; 
            border-radius: 30px; 
            background-color: #ff7e5f; 
            color: white; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .cart-summary-checkout:hover { background-color: #e86a4a; transform: translateY(-2px); }
        .cart-summary-checkout:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .cart-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 80px; 
            background-color: white; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 2rem; 
            z-index: 95; 
        }
        .cart-info { display: flex; align-items: center; gap: 1rem; cursor: pointer; }
        .cart-icon-container { position: relative; }
        .cart-icon { font-size: 1.8rem; color: #ff7e5f; }
        .cart-item-count { position: absolute; top: -10px; right: -10px; background-color: #ff7e5f; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; }
        .cart-text { font-size: 1.1rem; font-weight: 600; }
        .cart-total { font-size: 1.3rem; font-weight: bold; color: #ff7e5f; }
        .checkout-btn { padding: 0.8rem 2rem; border: none; border-radius: 30px; background-color: #ff7e5f; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .checkout-btn:hover { background-color: #e86a4a; transform: translateY(-2px); }
        .checkout-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        /* è´­ç‰©è½¦è¯¦æƒ…å¼¹çª— - å›¾2æ•ˆæœ */
        .cart-sidebar { 
            position: fixed; 
            bottom: 160px; 
            right: -100%; /* ä¿®æ”¹è¿™é‡Œï¼Œè®©åˆå§‹çŠ¶æ€å®Œå…¨éšè— */
            width: 100%; /* ä¿®æ”¹è¿™é‡Œï¼Œå®½åº¦æ”¹ä¸º100% */
            height: calc(100vh - 160px); 
            background-color: white; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: right 0.3s ease-in-out; 
            z-index: 94; 
            display: flex; 
            flex-direction: column; 
            border-radius: 12px 12px 0 0;
        }
        .cart-sidebar.open { right: 0; }
        .cart-sidebar-header { 
            padding: 1.5rem; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .cart-sidebar-header .select-all {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .select-all-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #ff7e5f;
        }
        .cart-sidebar-title { font-size: 1.3rem; font-weight: bold; }
        .close-cart-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .cart-items-list { flex: 1; overflow-y: auto; padding: 1rem; }
        .cart-item { 
            display: flex; 
            align-items: center; 
            padding: 1rem; 
            border-bottom: 1px solid #f9f9f9; 
            gap: 1rem; 
        }
        .cart-item-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #ff7e5f;
        }
        .cart-item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .cart-item-details { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .cart-item-name { font-weight: 600; margin-bottom: 0.3rem; }
        .cart-item-spec { font-size: 0.85rem; color: #666; }
        .cart-item-price { color: #ff7e5f; font-weight: bold; }
        .cart-item-quantity { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-btn { 
            width: 25px; 
            height: 25px; 
            border-radius: 50%; 
            border: 1px solid #ddd; 
            background-color: white; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1rem; 
            transition: all 0.2s ease; 
        }
        .quantity-btn:hover { background-color: #f0f0f0; }
        .quantity-btn.decrease:disabled { color: #ccc; cursor: not-allowed; background-color: white; }
        .cart-item-qty { font-weight: 600; width: 25px; text-align: center; }
        .remove-cart-item { 
            background: none; 
            border: none; 
            color: #ff7e5f; 
            cursor: pointer; 
            font-size: 1.2rem; 
            opacity: 0.7; 
            transition: all 0.2s ease; 
        }
        .remove-cart-item:hover { opacity: 1; transform: scale(1.1); }
        .cart-sidebar-footer { padding: 1.5rem; border-top: 1px solid #f0f0f0; }
        .cart-summary { display: flex; justify-content: space-between; font-size: 1.2rem; margin-bottom: 1rem; }
        .summary-label { font-weight: 600; }
        .summary-value { font-weight: bold; color: #ff7e5f; }
        .cart-actions { display: flex; gap: 1rem; }
        .clear-cart-btn, .checkout-sidebar-btn { 
            flex: 1; 
            padding: 0.8rem; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: none; 
        }
        .clear-cart-btn { background-color: #f8f8f8; color: #333; border: 1px solid #ddd; }
        .clear-cart-btn:hover { background-color: #f0f0f0; }
        .checkout-sidebar-btn { background-color: #ff7e5f; color: white; }
        .checkout-sidebar-btn:hover { background-color: #e86a4a; }
        .checkout-sidebar-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .empty-cart-message { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: #999; 
            text-align: center; 
            padding: 2rem; 
        }
        .empty-cart-message i { font-size: 4rem; margin-bottom: 1rem; color: #ffd1c0; }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 992px) { 
            .category-menu { width: 220px; } 
            .product-container { margin-left: 220px; padding: 1.5rem; } 
        }
        @media (max-width: 768px) { 
            .category-menu { width: 200px; } 
            .product-container { margin-left: 200px; } 
            .cart-bar, .cart-summary-bar { padding: 0 1rem; } 
            /* æ³¨é‡Šæ‰æˆ–åˆ é™¤è¿™ä¸€è¡Œï¼Œå› ä¸ºå®ƒä¼šè¦†ç›–æˆ‘ä»¬çš„å…¨å±€è®¾ç½® */
            /* .cart-sidebar { width: 320px; right: -320px; } */
        }
        @media (max-width: 576px) {
            .category-menu { 
                width: 100%; 
                transform: translateX(-100%); 
                transition: transform 0.3s ease; 
                z-index: 101; 
            }
            .category-menu.open { transform: translateX(0); }
            .product-container { margin-left: 0; padding-bottom: 90px; }
            .main-content { height: calc(100vh - 70px - 80px); }
            .mobile-menu-toggle { 
                display: block; 
                position: fixed; 
                top: 15px; 
                left: 15px; 
                z-index: 102; 
                background-color: white; 
                border: none; 
                width: 40px; 
                height: 40px; 
                border-radius: 50%; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
                font-size: 1.2rem; 
                color: #ff7e5f; 
                cursor: pointer; 
            }
            .cart-bar { height: 70px; }
            .cart-summary-bar { height: 70px; bottom: 70px; }
            .cart-sidebar { 
                bottom: 140px; 
                /* width: 100%; è¿™ä¸ªè®¾ç½®å·²ç»åœ¨å…¨å±€æ ·å¼ä¸­äº† */
                /* right: -100%; è¿™ä¸ªè®¾ç½®ä¹Ÿå·²ç»åœ¨å…¨å±€æ ·å¼ä¸­äº† */
                height: calc(100vh - 140px);
            }
            .cart-info { gap: 0.5rem; }
            .cart-icon { font-size: 1.5rem; }
            .cart-text { display: none; }
            .cart-total { font-size: 1.1rem; }
            .checkout-btn { padding: 0.6rem 1.2rem; font-size: 1rem; }
            .cart-summary-text { font-size: 0.9rem; }
            .cart-summary-checkout { padding: 0.5rem 1rem; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <!-- ç§»åŠ¨ç«¯èœå•åˆ‡æ¢æŒ‰é’® -->
    <button class="mobile-menu-toggle" style="display: none;"><i class="fa fa-bars"></i></button>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-nav">
        <div class="logo"><i class="fa fa-mug-hot"></i><h1>å¥¶èŒ¶å°é“º</h1></div>
        <div class="search-container"><i class="fa fa-search search-icon"></i><input type="text" class="search-input" placeholder="æœç´¢äº§å“åç§°ï¼ˆå¦‚ï¼šçç å¥¶èŒ¶ï¼‰"></div>
        <div class="mode-switch">
            <button id="takeoutBtn" class="mode-btn active"><i class="fa fa-motorcycle"></i> å¤–å–</button>
            <button id="selfPickupBtn" class="mode-btn"><i class="fa fa-store"></i> è‡ªå–</button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="category-menu">
            <h2><i class="fa fa-list"></i> äº§å“åˆ†ç±»</h2>
            <ul class="category-list">
                <li class="category-item" data-category="popular"><i class="fa fa-heart"></i><span>äººæ°”æ¨è</span></li>
                <li class="category-item" data-category="new"><i class="fa fa-fire"></i><span>æ–°å“ä¸Šå¸‚</span></li>
                <li class="category-item" data-category="classic"><i class="fa fa-coffee"></i><span>ç»å…¸å¥¶èŒ¶</span></li>
                <li class="category-item" data-category="fruit"><i class="fa fa-apple"></i><span>æ¸…çˆ½æœèŒ¶</span></li>
                <li class="category-item" data-category="smoothie"><i class="fa fa-snowflake-o"></i><span>å†°æ²™ç³»åˆ—</span></li>
                <li class="category-item" data-category="combo"><i class="fa fa-gift"></i><span>å¥—é¤ç»„åˆ</span></li>
            </ul>
        </div>
        <div class="product-container">
            <div class="product-header">
                <h2>è¯·é€‰æ‹©åˆ†ç±»æŸ¥çœ‹äº§å“</h2>
                <p>ç‚¹å‡»å·¦ä¾§åˆ†ç±»èœå•ï¼Œæµè§ˆå¯¹åº”äº§å“ç³»åˆ—</p>
                <div class="search-result-tip" id="searchResultTip"></div>
            </div>
            <div class="product-grid" id="productGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;"><i class="fa fa-hand-point-left fa-2x mb-3"></i><p>æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®...</p></div>
            </div>
            <template id="productCardTemplate">
                <div class="product-card" data-id="[[id]]" data-name="[[name]]" data-price="[[price]]" data-image="[[image_url]]">
                    <img src="[[image_url]]" alt="[[name]]" class="product-img">
                    <h3 class="product-title">[[name]]</h3>
                    <p class="product-desc">[[description]]</p>
                    <div class="product-price">Â¥[[price]]</div>
                    <button class="add-to-cart"><i class="fa fa-shopping-cart"></i> åŠ å…¥è´­ç‰©è½¦</button>
                </div>
            </template>
            <div class="empty-state" id="emptyState"><i class="fa fa-box-open"></i><h3>è¯¥åˆ†ç±»æš‚æ— äº§å“</h3><p>æ•¬è¯·æœŸå¾…æ–°å“ä¸Šæ¶~</p></div>
        </div>
    </div>

    <!-- è´­ç‰©è½¦æ‘˜è¦æ  - å›¾1æ•ˆæœ -->
    <div class="cart-summary-bar hidden" id="cartSummaryBar">
        <div class="cart-summary-info" id="cartSummaryInfo">
            <div class="cart-summary-icon-container">
                <i class="fa fa-shopping-cart cart-summary-icon"></i>
                <span class="cart-summary-count" id="cartSummaryCount">0</span>
            </div>
            <div class="cart-summary-text">
                <span id="cartSummaryText">2ä»¶å•†å“</span>
                <span>Â¥<span id="cartSummaryAmount">15</span></span>
            </div>
        </div>
        <button class="cart-summary-checkout" id="cartSummaryCheckout">å»ç»“ç®—</button>
    </div>

    <!-- è´­ç‰©è½¦ä¾§è¾¹æ  - å›¾2æ•ˆæœ -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-sidebar-header">
            <div class="select-all">
                <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox" checked>
                <span>å…¨é€‰</span>
            </div>
            <button class="close-cart-btn" id="closeCartBtn"><i class="fa fa-times"></i></button>
        </div>
        <div class="cart-items-list" id="cartItemsList">
            <div class="empty-cart-message" id="emptyCartMessage"><i class="fa fa-shopping-cart"></i><h3>è´­ç‰©è½¦æ˜¯ç©ºçš„</h3><p>å¿«å»æŒ‘é€‰ç¾å‘³çš„å¥¶èŒ¶å§ï¼</p></div>
        </div>
        <div class="cart-sidebar-footer">
            <div class="cart-summary"><span class="summary-label">æ€»è®¡:</span><span class="summary-value" id="cartTotalAmount">Â¥0.00</span></div>
            <div class="cart-actions"><button class="clear-cart-btn" id="clearCartBtn">æ¸…ç©ºè´­ç‰©è½¦</button><button class="checkout-sidebar-btn" id="checkoutSidebarBtn" disabled>å»ç»“ç®—</button></div>
        </div>
    </div>

    <!-- åº•éƒ¨è´­ç‰©è½¦æ  -->
    <div class="cart-bar">
        <div class="cart-info" id="cartInfo"><div class="cart-icon-container"><i class="fa fa-shopping-cart cart-icon"></i><span class="cart-item-count" id="cartItemCount">0</span></div><span class="cart-text">è´­ç‰©è½¦</span><span class="cart-total" id="cartBarTotal">Â¥0.00</span></div>
        <button class="checkout-btn" id="checkoutBarBtn" disabled>å»ç»“ç®—</button>
    </div>

    <script>
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const SUPABASE_URL = "https://gfvzqdydcjynxseiswwh.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmdnpxZHlkY2p5bnhzZWlzd3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDI0MDksImV4cCI6MjA3ODMxODQwOX0.n0gaMxtldCFEw0PkH_NKyN6J_e1vKJ5s8GwsKOGq0Q0";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM å…ƒç´ 
        const productGrid = document.getElementById('productGrid');
        const productCardTemplate = document.getElementById('productCardTemplate');
        const productHeaderTitle = document.querySelector('.product-header h2');
        const productHeaderDesc = document.querySelector('.product-header p');
        const categoryItems = document.querySelectorAll('.category-item');
        const emptyState = document.getElementById('emptyState');
        const searchResultTip = document.getElementById('searchResultTip');
        const searchInput = document.querySelector('.search-input');
        const cartInfo = document.getElementById('cartInfo');
        const cartSidebar = document.getElementById('cartSidebar');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const cartItemsList = document.getElementById('cartItemsList');
        const cartItemCount = document.getElementById('cartItemCount');
        const cartBarTotal = document.getElementById('cartBarTotal');
        const cartTotalAmount = document.getElementById('cartTotalAmount');
        const checkoutBarBtn = document.getElementById('checkoutBarBtn');
        const checkoutSidebarBtn = document.getElementById('checkoutSidebarBtn');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const categoryMenu = document.querySelector('.category-menu');
        // æ–°å¢è´­ç‰©è½¦æ‘˜è¦æ å…ƒç´ 
        const cartSummaryBar = document.getElementById('cartSummaryBar');
        const cartSummaryInfo = document.getElementById('cartSummaryInfo');
        const cartSummaryCount = document.getElementById('cartSummaryCount');
        const cartSummaryText = document.getElementById('cartSummaryText');
        const cartSummaryAmount = document.getElementById('cartSummaryAmount');
        const cartSummaryCheckout = document.getElementById('cartSummaryCheckout');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');

        // åˆ†ç±»æè¿°æ•°æ®
        const categoryData = {
            'popular': { title: 'äººæ°”æ¨èç³»åˆ—', desc: 'å…± 6 æ¬¾äº§å“ Â· é¡¾å®¢æœ€çˆ±ï¼Œå£ç¢‘ä¹‹é€‰' },
            'new': { title: 'æ–°å“ä¸Šå¸‚ç³»åˆ—', desc: 'å…± 4 æ¬¾äº§å“ Â· å…¨æ–°å£å‘³ï¼ŒæŠ¢å…ˆä½“éªŒ' },
            'classic': { title: 'ç»å…¸å¥¶èŒ¶ç³»åˆ—', desc: 'å…± 6 æ¬¾äº§å“ Â· æµ“éƒå¥¶é¦™ï¼Œç»å…¸æ»‹å‘³' },
            'fruit': { title: 'æ¸…çˆ½æœèŒ¶ç³»åˆ—', desc: 'å…± 5 æ¬¾äº§å“ Â· æ–°é²œæ°´æœï¼Œæ¸…çˆ½å£æ„Ÿ' },
            'smoothie': { title: 'å†°æ²™ç³»åˆ—', desc: 'å…± 5 æ¬¾äº§å“ Â· å†°çˆ½è§£æš‘ï¼Œæœé¦™å››æº¢' },
            'combo': { title: 'å¥—é¤ç»„åˆç³»åˆ—', desc: 'å…± 4 æ¬¾äº§å“ Â· è¶…å€¼æ­é…ï¼Œæ€§ä»·æ¯”é«˜' }
        };

        let categoryIdMap = {};
        let isCategoriesLoaded = false;

        // ----------------- è´­ç‰©è½¦æ ¸å¿ƒé€»è¾‘ -----------------
        let cart = JSON.parse(localStorage.getItem('milkTeaCart')) || [];
        const saveCart = () => localStorage.setItem('milkTeaCart', JSON.stringify(cart));
        const calculateTotal = () => cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const calculateItemCount = () => cart.reduce((count, item) => count + item.quantity, 0);

        // æ›´æ–°è´­ç‰©è½¦UI
        const updateCartUI = () => {
            saveCart();
            const total = calculateTotal();
            const itemCount = calculateItemCount();
            
            // æ›´æ–°ä¸»è´­ç‰©è½¦æ 
            cartItemCount.textContent = itemCount;
            cartBarTotal.textContent = `Â¥${total.toFixed(2)}`;
            cartTotalAmount.textContent = `Â¥${total.toFixed(2)}`;
            const isCartEmpty = cart.length === 0;
            checkoutBarBtn.disabled = isCartEmpty;
            checkoutSidebarBtn.disabled = isCartEmpty;
            cartSummaryCheckout.disabled = isCartEmpty;
            
            // æ›´æ–°è´­ç‰©è½¦æ‘˜è¦æ 
            cartSummaryCount.textContent = itemCount;
            cartSummaryAmount.textContent = total.toFixed(2);
            cartSummaryText.textContent = `${cart.length}ä»¶å•†å“`;
            
            // æ§åˆ¶è´­ç‰©è½¦æ‘˜è¦æ æ˜¾ç¤º/éšè—
            if (isCartEmpty) {
                cartSummaryBar.classList.add('hidden');
                emptyCartMessage.style.display = 'flex';
            } else {
                cartSummaryBar.classList.remove('hidden');
                emptyCartMessage.style.display = 'none';
            }
            
            // æ›´æ–°è´­ç‰©è½¦è¯¦æƒ…åˆ—è¡¨
            cartItemsList.innerHTML = '';
            if (isCartEmpty) { 
                cartItemsList.appendChild(emptyCartMessage); 
                return; 
            }
            
            cart.forEach((item, index) => {
                const cartItemElement = document.createElement('div');
                cartItemElement.className = 'cart-item';
                cartItemElement.innerHTML = `
                    <input type="checkbox" class="cart-item-checkbox" data-index="${index}" checked>
                    <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-spec">${item.spec || 'ä¸­æ¯,ä¸ƒåˆ†ç³–,æ­£å¸¸å†°'}</div>
                        <div class="cart-item-price">Â¥${item.price.toFixed(2)}</div>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="quantity-btn decrease" data-index="${index}">-</button>
                        <span class="cart-item-qty">${item.quantity}</span>
                        <button class="quantity-btn increase" data-index="${index}">+</button>
                    </div>
                    <button class="remove-cart-item" data-index="${index}"><i class="fa fa-trash"></i></button>
                `;
                cartItemsList.appendChild(cartItemElement);
            });

            // ç»‘å®šè´­ç‰©è½¦é¡¹ç›®äº‹ä»¶
            document.querySelectorAll('.quantity-btn.decrease').forEach(btn => 
                btn.addEventListener('click', (e) => adjustQuantity(parseInt(e.currentTarget.dataset.index), -1)));
            document.querySelectorAll('.quantity-btn.increase').forEach(btn => 
                btn.addEventListener('click', (e) => adjustQuantity(parseInt(e.currentTarget.dataset.index), 1)));
            document.querySelectorAll('.remove-cart-item').forEach(btn => 
                btn.addEventListener('click', (e) => removeFromCart(parseInt(e.currentTarget.dataset.index))));
            document.querySelectorAll('.cart-item-checkbox').forEach(checkbox => 
                checkbox.addEventListener('change', handleItemCheckboxChange));
        };

        // å¤„ç†è´­ç‰©è½¦é¡¹ç›®å¤é€‰æ¡†å˜åŒ–
        const handleItemCheckboxChange = () => {
            const allChecked = document.querySelectorAll('.cart-item-checkbox:checked').length === cart.length;
            selectAllCheckbox.checked = allChecked;
        };

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        selectAllCheckbox.addEventListener('change', () => {
            document.querySelectorAll('.cart-item-checkbox').forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });

        // ä»è´­ç‰©è½¦ç§»é™¤é¡¹ç›®
        const removeFromCart = (index) => { 
            cart.splice(index, 1); 
            updateCartUI(); 
        };

        // è°ƒæ•´è´­ç‰©è½¦é¡¹ç›®æ•°é‡
        const adjustQuantity = (index, delta) => {
            const newQuantity = cart[index].quantity + delta;
            if (newQuantity > 0) { 
                cart[index].quantity = newQuantity; 
                updateCartUI(); 
            }
        };

        // æ¸…ç©ºè´­ç‰©è½¦
        const clearCart = () => { 
            if(confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) { 
                cart = []; 
                updateCartUI(); 
            } 
        };

        // æ·»åŠ åˆ°è´­ç‰©è½¦
        const addToCart = (product) => {
            // é»˜è®¤æ·»åŠ ä¸€äº›è§„æ ¼ä¿¡æ¯ï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä»è§„æ ¼é€‰æ‹©ç•Œé¢è·å–
            const productWithSpec = {
                ...product,
                spec: 'ä¸­æ¯,ä¸ƒåˆ†ç³–,æ­£å¸¸å†°(æ¨è)'
            };
            
            const existingItemIndex = cart.findIndex(item => item.id === product.id);
            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += 1;
            } else {
                cart.push({ ...productWithSpec, quantity: 1 });
            }
            
            updateCartUI();
            
            // æ·»åŠ è´­ç‰©è½¦åŠ¨ç”»
            const cartIcon = document.querySelector('.cart-icon');
            cartIcon.classList.add('added-animation');
            setTimeout(() => cartIcon.classList.remove('added-animation'), 500);
            
            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸæç¤º
            alert(`âœ… ${product.name} å·²åŠ å…¥è´­ç‰©è½¦ï¼`);
            
            // ç¡®ä¿è´­ç‰©è½¦æ‘˜è¦æ æ˜¾ç¤º
            cartSummaryBar.classList.remove('hidden');
        };
        
        updateCartUI(); // åˆå§‹åŒ–è´­ç‰©è½¦UI

        // ----------------- äº§å“å’Œåˆ†ç±»é€»è¾‘ -----------------
        async function loadCategories() {
            try {
                const { data, error } = await supabase.from('categories').select('id, slug');
                if (error) throw error;
                data.forEach(category => categoryIdMap[category.slug] = category.id);
                isCategoriesLoaded = true;
                if (categoryItems.length > 0) categoryItems[0].click();
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                productGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #ff7e5f;"><i class="fa fa-exclamation-circle fa-2x mb-3"></i><p>åˆ†ç±»æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>`;
            }
        }

        function renderProducts(products) {
            productGrid.innerHTML = '';
            if (products.length === 0) { 
                emptyState.style.display = 'flex'; 
                return; 
            }
            emptyState.style.display = 'none';
            
            products.forEach(product => {
                const cardClone = document.importNode(productCardTemplate.content, true);
                const card = cardClone.querySelector('.product-card');
                card.querySelector('.product-img').src = product.image_url;
                card.querySelector('.product-title').textContent = product.name;
                card.querySelector('.product-desc').textContent = product.description || 'æš‚æ— æè¿°';
                card.querySelector('.product-price').textContent = `Â¥${product.price.toFixed(2)}`;
                card.dataset.id = product.id;
                card.dataset.name = product.name;
                card.dataset.price = product.price;
                card.dataset.image = product.image_url;

                // ç»‘å®šåŠ å…¥è´­ç‰©è½¦æŒ‰é’®äº‹ä»¶
                const addBtn = card.querySelector('.add-to-cart');
                addBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    const productData = {
                        id: card.dataset.id,
                        name: card.dataset.name,
                        price: parseFloat(card.dataset.price),
                        image: card.dataset.image
                    };
                    addToCart(productData);
                });

                // å¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºæŸ¥çœ‹è¯¦æƒ…
                card.addEventListener('click', function() {
                    alert(`ğŸ“‹ æŸ¥çœ‹ã€${product.name}ã€‘è¯¦æƒ…\n\nè§„æ ¼ï¼šä¸­æ¯(500ml) / å¤§æ¯(700ml)\nç”œåº¦ï¼šå…¨ç³–/åŠç³–/å°‘ç³–/æ— ç³–\nå†°åº¦ï¼šæ­£å¸¸å†°/å°‘å†°/å»å†°/çƒ­é¥®\né…æ–™ï¼šå¯é¢å¤–æ·»åŠ çç ã€æ¤°æœç­‰`);
                });
                
                productGrid.appendChild(cardClone);
            });
        }

        // åˆ†ç±»èœå•ç‚¹å‡»äº‹ä»¶
        categoryItems.forEach(item => {
            item.addEventListener('click', async function() {
                if (!isCategoriesLoaded) { 
                    alert('åˆ†ç±»æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•ï¼'); 
                    return; 
                }
                categoryItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                const categorySlug = this.getAttribute('data-category');
                const currentCategoryData = categoryData[categorySlug];
                productHeaderTitle.textContent = currentCategoryData.title;
                productHeaderDesc.textContent = currentCategoryData.desc;
                searchResultTip.style.display = 'none';
                productGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #ff7e5f;"><i class="fa fa-spinner fa-spin fa-2x mb-3"></i><p>åŠ è½½ä¸­...</p></div>';
                emptyState.style.display = 'none';
                
                try {
                    const categoryId = categoryIdMap[categorySlug];
                    if (!categoryId) throw new Error(`æœªæ‰¾åˆ°åˆ†ç±»"${categorySlug}"å¯¹åº”çš„ID`);
                    const { data, error } = await supabase.from('products').select('*')
                        .eq('category_id', categoryId)
                        .order('display_order', { ascending: true });
                    if (error) throw error;
                    renderProducts(data);
                } catch (error) {
                    console.error('åŠ è½½äº§å“å¤±è´¥:', error);
                    productGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #ff7e5f;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
                
                document.querySelector('.product-container').scrollTop = 0;
            });
        });

        // æœç´¢åŠŸèƒ½
        if (searchInput) {
            searchInput.addEventListener('input', async function() {
                const searchKey = this.value.trim().toLowerCase();
                if (!searchKey) {
                    searchResultTip.style.display = 'none';
                    const activeCategory = document.querySelector('.category-item.active');
                    if (activeCategory) { 
                        activeCategory.click(); 
                    } else {
                        productGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;"><i class="fa fa-hand-point-left fa-2x mb-3"></i><p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªåˆ†ç±»å¼€å§‹æµè§ˆ</p></div>';
                        productHeaderTitle.textContent = 'è¯·é€‰æ‹©åˆ†ç±»æŸ¥çœ‹äº§å“';
                        productHeaderDesc.textContent = 'ç‚¹å‡»å·¦ä¾§åˆ†ç±»èœå•ï¼Œæµè§ˆå¯¹åº”äº§å“ç³»åˆ—';
                    }
                    return;
                }
                
                productHeaderTitle.textContent = 'æœç´¢ç»“æœ';
                productHeaderDesc.textContent = '';
                productGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #ff7e5f;"><i class="fa fa-search fa-spin fa-2x mb-3"></i><p>æœç´¢ä¸­...</p></div>';
                emptyState.style.display = 'none';
                
                try {
                    const { data, error } = await supabase.from('products').select('*')
                        .ilike('name', `%${searchKey}%`)
                        .order('display_order');
                    if (error) throw error;
                    renderProducts(data);
                    searchResultTip.style.display = 'block';
                    searchResultTip.textContent = `æœç´¢ç»“æœï¼šæ‰¾åˆ° ${data.length} æ¬¾ç›¸å…³äº§å“`;
                } catch (error) {
                    console.error('æœç´¢äº§å“å¤±è´¥:', error);
                    productGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #ff7e5f;">æœç´¢å¤±è´¥: ${error.message}</div>`;
                }
            });
        }

        // æ¨¡å¼åˆ‡æ¢
        const modeBtns = document.querySelectorAll('.mode-btn');
        modeBtns.forEach(btn => btn.addEventListener('click', function() {
            modeBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        }));

        // è´­ç‰©è½¦ç›¸å…³äº‹ä»¶ç»‘å®š
        cartInfo.addEventListener('click', () => cartSidebar.classList.add('open'));
        closeCartBtn.addEventListener('click', () => cartSidebar.classList.remove('open'));
        cartSummaryInfo.addEventListener('click', () => cartSidebar.classList.add('open'));
        
        // ç»“ç®—æŒ‰é’®äº‹ä»¶
        checkoutBarBtn.addEventListener('click', () => cartSidebar.classList.add('open'));
        checkoutSidebarBtn.addEventListener('click', () => {
            alert(`âœ… ç»“ç®—æˆåŠŸï¼\n\næ€»è®¡: ${cartTotalAmount.textContent}\n\næ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼`);
            cart = [];
            updateCartUI();
            cartSidebar.classList.remove('open');
        });
        cartSummaryCheckout.addEventListener('click', () => {
            cartSidebar.classList.add('open');
        });
        
        // æ¸…ç©ºè´­ç‰©è½¦äº‹ä»¶
        clearCartBtn.addEventListener('click', clearCart);

        // ç§»åŠ¨ç«¯èœå•å¤„ç†
        function handleResize() {
            if (window.innerWidth <= 576) {
                mobileMenuToggle.style.display = 'block';
            } else {
                mobileMenuToggle.style.display = 'none';
                categoryMenu.classList.remove('open');
            }
        }
        window.addEventListener('resize', handleResize);
        handleResize();
        mobileMenuToggle.addEventListener('click', () => categoryMenu.classList.toggle('open'));

        // åŠ å…¥è´­ç‰©è½¦åŠ¨ç”»
        document.head.insertAdjacentHTML('beforeend', `
        <style>
            .cart-icon.added-animation { animation: cartBounce 0.5s ease; }
            @keyframes cartBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        </style>`);

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½åˆ†ç±»
        window.addEventListener('DOMContentLoaded', loadCategories);
    </script>
</body>
</html>