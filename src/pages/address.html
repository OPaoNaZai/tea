<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è´§åœ°å€ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            min-width: 320px;
            padding: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            margin-top: 0;
        }
        .header .back {
            font-size: 24px;
            text-decoration: none;
            color: #333;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .header .empty {
            width: 24px;
        }
        .main-content {
            background-color: #fff;
            padding: 0px 20px; /* å…³é”®ä¿®æ”¹ï¼šé¡¶éƒ¨ padding ä» 20px æ”¹ä¸º 15pxï¼Œå‡å°‘æ ‡é¢˜ä¸æ·»åŠ æŒ‰é’®çš„è·ç¦» */
            margin-bottom: 70px;
        }
        .message {
            text-align: center;
            padding: 10px 16px;
            margin: 0 0 5px 0; /* å…³é”®ä¿®æ”¹ï¼šåº•éƒ¨ margin ä» 16px æ”¹ä¸º 12pxï¼Œè®©æç¤ºæ¡†æ›´ç´§å‡‘ */
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        /* æ·»åŠ æ–°åœ°å€å¡ç‰‡ - å…³é”®ä¿®æ”¹ï¼šå»æ‰é¡¶éƒ¨ marginï¼Œå‡å°‘ä¸æ ‡é¢˜çš„è·ç¦» */
        .add-address-card {
            background-color: #f9f9f9;
            border: 1px dashed #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 0 0 25px 0; /* é¡¶éƒ¨ margin ä» 16px æ”¹ä¸º 0ï¼Œåº•éƒ¨ margin ä» 16px æ”¹ä¸º 12px */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .add-address-card:hover {
            border-color: #007bff;
            background-color: #f0f7ff;
        }
        .add-address-card button {
            background: none;
            border: none;
            color: #007bff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px 0;
        }
        .add-address-card button::before {
            content: "+";
            font-size: 18px;
            margin-right: 8px;
            font-weight: bold;
        }
        .form-container {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px; /* å…³é”®ä¿®æ”¹ï¼šåº•éƒ¨ margin ä» 16px æ”¹ä¸º 12px */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        .form-container h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }
        /* åœ°å€åˆ—è¡¨ - å…³é”®ä¿®æ”¹ï¼šä¸ºåˆ—è¡¨å®¹å™¨æ·»åŠ åº•éƒ¨å†…è¾¹è· */
        #addressList {
            display: flex;
            flex-direction: column;
            gap: 15px; /* åœ°å€é¡¹ä¹‹é—´çš„é—´è· */
            padding-bottom: 50px; /* å…³é”®ä¿®æ”¹ï¼šå¢åŠ åˆ—è¡¨åº•éƒ¨ä¸æ¨¡å—è¾¹æ¡†çš„è·ç¦» */
        }
        .address-item {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
            position: relative;
        }
        .address-item:hover {
            border-color: #007bff;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        .address-info p {
            margin: 4px 0;
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }
        .address-info p strong {
            color: #333;
            font-weight: 500;
        }
        .default-tag {
            display: inline-block;
            background-color: #28a745;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-top: 5px;
            font-weight: bold;
        }
        .address-actions {
            position: absolute;
            right: 15px;
            top: 15px;
        }
        .address-actions button {
            background: none;
            border: none;
            padding: 6px 10px;
            margin-left: 5px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .edit-btn {
            color: #007bff;
        }
        .edit-btn:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .delete-btn {
            color: #dc3545;
        }
        .delete-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        #submitBtn, #cancelBtn {
            width: 48%;
            padding: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        #submitBtn {
            background-color: #28a745;
            color: white;
        }
        #submitBtn:hover {
            background-color: #218838;
        }
        #cancelBtn {
            background-color: #f8f9fa;
            color: #333;
        }
        #cancelBtn:hover {
            background-color: #e2e6ea;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            text-decoration: none;
            font-size: 11px;
            flex: 1;
            height: 100%;
            justify-content: center;
        }
        .nav-item.active {
            color: #007bff;
        }
        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }
        .icon-home::before { content: "ğŸ "; }
        .icon-order::before { content: "ğŸ“"; }
        .icon-user::before { content: "ğŸ‘¤"; }

        @media (min-width: 768px) {
            .main-content {
                padding: 0px 40px; /* å…³é”®ä¿®æ”¹ï¼šé¡¶éƒ¨ padding ä» 25px æ”¹ä¸º 20px */
            }
            .address-item {
                padding: 20px;
            }
            .address-info p {
                font-size: 15px;
            }
            input, select {
                padding: 14px 15px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <a href="javascript:goBack()" class="back">&lt;</a>
        <h1>æ”¶è´§åœ°å€ç®¡ç†</h1>
        <div class="empty"></div>
    </div>

    <div class="main-content">
        <div id="message" class="message"></div>

        <!-- æ·»åŠ æ–°åœ°å€å¡ç‰‡ -->
        <div class="add-address-card" onclick="showAddForm()">
            <button type="button">æ·»åŠ æ–°åœ°å€</button>
        </div>
        
        <!-- åœ°å€è¡¨å• -->
        <div class="form-container" id="addressForm">
            <h2 id="form-title">æ·»åŠ æ–°åœ°å€</h2>
            <input type="text" id="name" placeholder="æ”¶è´§äººå§“å" required>
            <input type="tel" id="phone" placeholder="è”ç³»ç”µè¯" required>
            <input type="text" id="region" placeholder="åœ°åŒºï¼ˆçœå¸‚åŒºï¼‰" required>
            <input type="text" id="detail" placeholder="è¯¦ç»†åœ°å€ï¼ˆè¡—é“ã€é—¨ç‰Œå·ç­‰ï¼‰" required>
            <select id="isDefault">
                <option value="true">è®¾ä¸ºé»˜è®¤åœ°å€</option>
                <option value="false">éé»˜è®¤åœ°å€</option>
            </select>
            <div class="button-group">
                <button id="submitBtn" onclick="handleSubmit()">ä¿å­˜åœ°å€</button>
                <button id="cancelBtn" onclick="hideForm()">å–æ¶ˆ</button>
            </div>
        </div>
        
        <!-- åœ°å€åˆ—è¡¨ -->
        <div id="addressList"></div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="icon-home"></i>
            <span>é¦–é¡µ</span>
        </a>
        <a href="orders.html" class="nav-item">
            <i class="icon-order"></i>
            <span>è®¢å•</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="icon-user"></i>
            <span>æˆ‘çš„</span>
        </a>
    </div>

    <script>
        // æ‰€æœ‰ JS é€»è¾‘å®Œå…¨ä¸å˜
        const SUPABASE_URL = "https://gfvzqdydcjynxseiswwh.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmdnpxZHlkY2p5bnhzZWlzd3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDI0MDksImV4cCI6MjA3ODMxODQwOX0.n0gaMxtldCFEw0PkH_NKyN6J_e1vKJ5s8GwsKOGq0Q0";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUserId = null;
        let editingAddressId = null;
        const STORAGE_KEY = 'persistent_auth_session';

        function goBack() {
            window.history.back();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const savedSession = localStorage.getItem(STORAGE_KEY);
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData.expiresAt > new Date().getTime()) {
                        currentUserId = sessionData.userId;
                        await loadAddresses();
                        return;
                    }
                }

                const { data: { session } } = await supabase.auth.getSession();
                if (session && session.user) {
                    currentUserId = session.user.id;
                    await loadAddresses();
                } else {
                    showMessage('è¯·å…ˆç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        });

        async function loadAddresses() {
            try {
                const { data, error } = await supabase
                   .from('addresses')
                   .select('*')
                   .eq('user_id', currentUserId);

                if (error) throw error;

                const addressList = document.getElementById('addressList');
                addressList.innerHTML = '';

                if (data.length === 0) {
                    addressList.innerHTML = '<div style="text-align: center; padding: 30px 0; color: #999; font-size: 14px;">æš‚æ— æ”¶è´§åœ°å€</div>';
                    return;
                }

                data.forEach(address => {
                    const addressItem = document.createElement('div');
                    addressItem.className = 'address-item';
                    addressItem.innerHTML = `
                        <div class="address-info">
                            <p><strong>${address.name}</strong> ${address.phone}</p>
                            <p>${address.region} ${address.detail}</p>
                            ${address.is_default ? '<span class="default-tag">é»˜è®¤åœ°å€</span>' : ''}
                        </div>
                        <div class="address-actions">
                            <button class="edit-btn" onclick="editAddress(${address.id})">ç¼–è¾‘</button>
                            <button class="delete-btn" onclick="deleteAddress(${address.id})">åˆ é™¤</button>
                        </div>
                    `;
                    addressList.appendChild(addressItem);
                });
            } catch (error) {
                console.error('åŠ è½½åœ°å€å¤±è´¥:', error);
                showMessage('åŠ è½½åœ°å€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function handleSubmit() {
            try {
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const region = document.getElementById('region').value.trim();
                const detail = document.getElementById('detail').value.trim();
                const isDefault = document.getElementById('isDefault').value === 'true';

                if (!name) return showMessage('è¯·å¡«å†™æ”¶è´§äººå§“å', 'error');
                if (!phone || !/^1[3-9]\d{9}$/.test(phone)) return showMessage('è¯·å¡«å†™æ­£ç¡®çš„11ä½æ‰‹æœºå·', 'error');
                if (!region) return showMessage('è¯·å¡«å†™åœ°åŒºï¼ˆçœå¸‚åŒºï¼‰', 'error');
                if (!detail) return showMessage('è¯·å¡«å†™è¯¦ç»†åœ°å€', 'error');

                if (isDefault) {
                    await supabase
                       .from('addresses')
                       .update({ is_default: false })
                       .eq('user_id', currentUserId);
                }

                if (editingAddressId) {
                    const { error } = await supabase
                       .from('addresses')
                       .update({
                            name,
                            phone,
                            region,
                            detail,
                            is_default: isDefault
                        })
                       .eq('id', editingAddressId);

                    if (error) throw error;
                    showMessage('åœ°å€ç¼–è¾‘æˆåŠŸ', 'success');
                } else {
                    const { error } = await supabase
                       .from('addresses')
                       .insert([{
                            user_id: currentUserId,
                            name,
                            phone,
                            region,
                            detail,
                            is_default: isDefault
                        }]);

                    if (error) throw error;
                    showMessage('åœ°å€æ·»åŠ æˆåŠŸ', 'success');
                }

                clearForm();
                hideForm();
                await loadAddresses();
            } catch (error) {
                console.error('æäº¤åœ°å€å¤±è´¥:', error);
                showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function editAddress(id) {
            try {
                const { data, error } = await supabase
                   .from('addresses')
                   .select('*')
                   .eq('id', id)
                   .single();

                if (error) throw error;

                document.getElementById('form-title').textContent = 'ç¼–è¾‘åœ°å€';
                document.getElementById('name').value = data.name;
                document.getElementById('phone').value = data.phone;
                document.getElementById('region').value = data.region;
                document.getElementById('detail').value = data.detail;
                document.getElementById('isDefault').value = data.is_default.toString();
                document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
                
                editingAddressId = id;
                showForm();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('è·å–åœ°å€ä¿¡æ¯å¤±è´¥:', error);
                showMessage('è·å–åœ°å€ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        function showAddForm() {
            editingAddressId = null;
            document.getElementById('form-title').textContent = 'æ·»åŠ æ–°åœ°å€';
            document.getElementById('submitBtn').textContent = 'ä¿å­˜åœ°å€';
            clearForm();
            document.getElementById('isDefault').value = 'true';
            showForm();
        }

        function showForm() {
            document.getElementById('addressForm').style.display = 'block';
        }

        function hideForm() {
            document.getElementById('addressForm').style.display = 'none';
        }

        async function deleteAddress(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°å€å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤')) {
                try {
                    const { error } = await supabase
                       .from('addresses')
                       .delete()
                       .eq('id', id);

                    if (error) throw error;
                    showMessage('åœ°å€åˆ é™¤æˆåŠŸ', 'success');
                    await loadAddresses();
                } catch (error) {
                    console.error('åˆ é™¤åœ°å€å¤±è´¥:', error);
                    showMessage('åˆ é™¤åœ°å€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            }
        }

        function clearForm() {
            document.getElementById('name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('region').value = '';
            document.getElementById('detail').value = '';
            document.getElementById('isDefault').value = 'true';
        }

        function showMessage(content, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = content;
            messageElement.className = `message ${type}`;
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.className = 'message';
            }, 3000);
        }
    </script>
</body>
</html>